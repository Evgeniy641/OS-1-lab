import ctypes
from ctypes import wintypes

#класс для информации о версии виндоус
class ver_os(ctypes.Structure):
    _fields_ = [
        ("razmer", wintypes.DWORD),       #размер структуры
        ("glavnaya", wintypes.DWORD),     #основная версия
        ("dopolnaya", wintypes.DWORD),    #дополнительная версия
        ("sborka", wintypes.DWORD),       #номер сборки
        ("platforma", wintypes.DWORD),    #id платформы
        ("service", wintypes.WCHAR * 128) #сервис пак
    ]

#функция для получения версии виндоус
def pol_os_ver():
    ntdll = ctypes.WinDLL("ntdll")
    rtl = ntdll.RtlGetVersion
    rtl.argtypes = [ctypes.POINTER(ver_os)]
    rtl.restype = wintypes.DWORD

    ver = ver_os()
    ver.razmer = ctypes.sizeof(ver)
    rtl(ctypes.byref(ver))

    if ver.glavnaya >= 10:
        return "windows 10 or greater"
    elif ver.glavnaya == 6 and ver.dopolnaya >= 3:
        return "windows 8.1"
    elif ver.glavnaya == 6 and ver.dopolnaya == 2:
        return "windows 8"
    else:
        return f"windows {ver.glavnaya}.{ver.dopolnaya}"

#получения имени компьютера
def komp_name():
    size = wintypes.DWORD(256)
    buf = ctypes.create_unicode_buffer(256)
    ctypes.windll.kernel32.GetComputerNameW(buf, ctypes.byref(size))
    return buf.value

#получения имени пользователя
def polz_name():
    size = wintypes.DWORD(256)
    buf = ctypes.create_unicode_buffer(256)
    ctypes.windll.advapi32.GetUserNameW(buf, ctypes.byref(size))
    return buf.value

#информации о процессоре
class sist_info(ctypes.Structure):
    _fields_ = [
        ("arch", wintypes.WORD),          #архитектура
        ("rezerv", wintypes.WORD),        #резерв
        ("stranica", wintypes.DWORD),     #размер страницы
        ("min_addr", wintypes.LPVOID),    #минимальный адрес
        ("max_addr", wintypes.LPVOID),    #максимальный адрес
        ("mask_proc", wintypes.LPVOID),   #маска процессоров
        ("kol_proc", wintypes.DWORD),     #количество процессоров
        ("tip_proc", wintypes.DWORD),     #тип процессора
        ("gran", wintypes.DWORD),         #гранулярность
        ("uroven", wintypes.WORD),        #уровень процессора
        ("rev", wintypes.WORD)            #ревизия
    ]

#получения количества процессоров и архитектуры
def cpu_info():
    info = sist_info()
    ctypes.windll.kernel32.GetNativeSystemInfo(ctypes.byref(info))
    arch_dict = {0:"x86",5:"ARM",9:"x64"}
    arch_name = arch_dict.get(info.arch,f"unknown({info.arch})")
    if arch_name=="x64":
        arch_name+="(AMD64)"
    return info.kol_proc, arch_name

#информации о памяти
class pamyat(ctypes.Structure):
    _fields_ = [
        ("razmer", wintypes.DWORD),       #размер структуры
        ("zagruzka", wintypes.DWORD),     #загруженность
        ("fiz_vsego", ctypes.c_ulonglong),   #физ всего
        ("fiz_dostup", ctypes.c_ulonglong),  #физ доступ
        ("file_vsego", ctypes.c_ulonglong),  #файл подкачки всего
        ("file_dostup", ctypes.c_ulonglong), #файл подкачки доступно
        ("virt_vsego", ctypes.c_ulonglong),  #виртуал всего
        ("virt_dostup", ctypes.c_ulonglong), #виртуал доступ
        ("virt_ext", ctypes.c_ulonglong)     #расширенная виртуал
    ]

#получения информации о памяти
def pamyat_info():
    p = pamyat()
    p.razmer = ctypes.sizeof(p)
    ctypes.windll.kernel32.GlobalMemoryStatusEx(ctypes.byref(p))
    return p

#информации о файле подкачки
class pagefile(ctypes.Structure):
    _fields_ = [
        ("razmer", wintypes.DWORD),       #размер структуры
        ("commit_now", ctypes.c_size_t),  #текущее использование
        ("commit_max", ctypes.c_size_t),  #лимит
        ("commit_peak", ctypes.c_size_t), #пик
        ("fiz_vsego", ctypes.c_size_t),   #физ всего
        ("fiz_dostup", ctypes.c_size_t),  #физ доступ
        ("kesh", ctypes.c_size_t),        #системный кеш
        ("kern_vsego", ctypes.c_size_t),  #ядро всего
        ("kern_page", ctypes.c_size_t),   #ядро страница
        ("kern_nopage", ctypes.c_size_t), #ядро без страницы
        ("page_size", ctypes.c_size_t),   #размер страницы
        ("handle", wintypes.DWORD),       #количество хэндлов
        ("proc", wintypes.DWORD),         #количество процессов
        ("potok", wintypes.DWORD)         #количество потоков
    ]

#получения информации о файле подкачки
def page_info():
    p = pagefile()
    p.razmer = ctypes.sizeof(p)
    ctypes.windll.psapi.GetPerformanceInfo(ctypes.byref(p), p.razmer)
    return p

#получения списка дисков
def diski():
    size = ctypes.windll.kernel32.GetLogicalDriveStringsW(0,None)
    buf = ctypes.create_unicode_buffer(size)
    ctypes.windll.kernel32.GetLogicalDriveStringsW(size,buf)
    d = buf.value.split("\x00")
    return [x for x in d if x]

#получения свободного/общего места и файловой системы диска
def disk_info(disk):
    free = ctypes.c_ulonglong()
    total = ctypes.c_ulonglong()
    free_user = ctypes.c_ulonglong()
    ctypes.windll.kernel32.GetDiskFreeSpaceExW(ctypes.c_wchar_p(disk),ctypes.byref(free_user),ctypes.byref(total),ctypes.byref(free))
    fs = ctypes.create_unicode_buffer(10)
    ctypes.windll.kernel32.GetVolumeInformationW(ctypes.c_wchar_p(disk),None,0,None,None,None,fs,len(fs))
    return free.value,total.value,fs.value


def main():
    print(f"os:{pol_os_ver()}\n")
    komp=komp_name()
    polz=polz_name()
    print(f"computer:{komp}")
    print(f"user:{polz}\n")
    proc,arch=cpu_info()
    print(f"architecture:{arch}")
    pam=pamyat_info()
    print(f"ram:{pam.fiz_dostup//1024//1024}MB / {pam.fiz_vsego//1024//1024}MB")
    print(f"virtual memory:{pam.virt_vsego//1024//1024}MB")
    print(f"memory load:{pam.zagruzka}%")
    pf=page_info()
    pf_total=pf.commit_max*pf.page_size
    pf_used=pf.commit_now*pf.page_size
    print(f"pagefile:{pf_used//1024//1024}MB / {pf_total//1024//1024}MB\n")
    print(f"processors:{proc}")
    print("drives:")
    for d in diski():
        free,total,fs=disk_info(d)
        print(f"  - {d}({fs}):{free//1024//1024//1024}GB free / {total//1024//1024//1024}GB total")

if __name__=="__main__":
    main()
